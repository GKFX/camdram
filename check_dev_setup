#!/bin/bash
set -e
export SYMFONY_ENV=dev

# Perform initial installaion with Elasticsearch stopped
sudo service elasticsearch stop
# Install deps again, which will create a new parameters.yml with default values
composer create-project camdram/camdram $HOME/camdramdev dev-master#$TRAVIS_COMMIT --no-interaction --keep-vcs
cd $HOME/camdramdev
# Start Elasticsearch and populate index
sudo service elasticsearch start
sleep 10
php app/console fos:elastica:populate

#Create a mysql database and test migrations
mysql -e 'CREATE DATABASE camdram_test;'
cp app/config/parameters.travis_mysql.yml app/config/parameters.yml
composer install --no-interaction
php app/console doctrine:migrations:migrate --no-interaction
php app/console doctrine:fixtures:load --no-interaction